# Защита от шторма сообщений

Защита от шторма сообщений работает следующим образом.

Все действия осуществляются в одном из двух мест:
1. в сервисе, который использует защиту от шторма - путем вызова методов объекта `StormProtection`
2. в самом объекте StormProtection в обработчике `storm_round_handler`, который запускается периодически с промежутком `storm_round_duration` секунд. Обработчик производит изменения флагов и другие действия по результатам анализа данных, накопленных за прошедшее с предыдущего запуска время (раунд проверки).

В сервисе должны быть осуществлены следующие дествия:
* создание и инициализация объекта `StormProtection`
* обновление счетчика сообщений при приходе нового сообщения (метод `update_messages_counter`)
* осуществление реакции на приход нового сообщения по текущим параметрам, то есть по параметрам расчитанным за закончившийся период `storm_round_handler`. Для "говорливых" устройств (метод `device_is_talkative`) в зависимости от политики cfg.storm_policy сообщение либо блокируется, либо поднимается авария, либо и то и другое.

В обработчике `storm_round_handler` для всех отслеживаемых устройств производятся следующие действия:
* установка или сброс флага "говорливости" устройства
* сброс счетчика сообщений
* изменение счетчика времени жизни записи (поле `ttl`) в таблице отслеживаемых устройств. Если он достиг предельного значения `storm_record_ttl`, то запись удаляется (это устройство, от которого не приходят сообщения и оно должно быть удалено из таблицы устройств для экономии памяти)
* сброс аварии если она была поднята, а флаг "говорливости" уже снят.

# Правила реагирования на алерты

| Алертгруппа      	| Имя  алерта                   	 | Описание                                                                                             	                                                  | Алгоритм  обработки алерта 	                                                                                                                                                                                                                                                                                                                                      |
|---------	|---------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| blackbox.rules   	| EndpointDown                  	 | Не доступен веб-сервис или ldap сервер                                                                                                 	                | Зайти на ноду endpoint'a, с помощью логов выяснить причину падения, восстановить работу сервиса                                                                                                                                                                                                                                                                   |
| blackbox.rules   	| SSLCertExpiringSoon           	 | Срок действия SSL для (имя домена) истекает через (кол-во дней)                                      	                                                  | Перевыпустить сертификат или обратиться к тому кто его выдавал                          	                                                                                                                                                                                                                                                                         |
| clickhouse.rules 	| ClickhouseInsertRateLow       	 | На хосте у кликхауса низкая скорость вставки                                                         	                                                  | Посмотреть в графиках среднюю скорость вставки, проверить статус Clickhouse, проверить chwriter  	                                                                                                                                                                                                                                                                |
| clickhouse.rules 	| DiskSpacePredictionCH         	 | Загрузка места на диске Кликхауса превысит 97% через 3 дня                                           	                                                  | Очистка старых записей в кликхаусе с помощью chpolicy                         	                                                                                                                                                                                                                                                                                   |
| consul.rules     	| ConsulServicesCountDecrease   	 | Более 50% экземпляров не работают                                                                    	                                                  | Посмотреть почему сервисы отвалились от консула, смотреть подбронее [**здесь**](./handbook-alerts-noc/ConsulServicesCountDecrease.md)                      	                                                                                                                                                                                                      |
| infra.rules      	| CPUUsageHigh                  	 | Загрузка процессора превышает 90%                                                                    	                                                  | Перейти на ноду и найти процесс который больше всего нагружает процессор, завершить процесс                          	                                                                                                                                                                                                                                            |
| infra.rules      	| MemoryUsageHigh               	 | Использование памяти превышает 90%                                                                   	                                                  | Перейти на ноду и найти процесс который больше всего потребляет оперативную память, завершить процесс                          	                                                                                                                                                                                                                                  |
| infra.rules      	| SwapUsageHigh                 	 | Загрузка Swap превышает 90%                                                                          	                                                  | Перейти на ноду и найти процесс который больше всего потребляет swap, завершить процесс                          	                                                                                                                                                                                                                                                |
| infra.rules      	| LoadAverageHigh               	 | Высокий ЛА                                                                                           	                                                  | Перейти на ноду и найти процесс который больше всего нагружает процессор, завершить процесс                                                                                                                                                                                                                                                                       |
| infra.rules      	| DiskSpaceUsage                	 | Загрузка места на диске превышает 90%                                                                	                                                  | В зависимости от типа ноды, необходимо предпринять следующие действия:<br/>1)Для MongoDB - выгрузить архивные коллекции, запустить компакт, в крайнем случае запустить переливку данных<br/>2) Для Postgres - проверить сколько весят логи postgres'a (ротация логов, очистка логов)<br/>3) Для Clickhouse -<br/>4)Провести исследования                        	 |
| infra.rules      	| DiskInodesUsageHigh           	 | Загрузка айнод на диске превышает 90%                                                                	                                                  | Провести исследования                          	                                                                                                                                                                                                                                                                                                                  |
| infra.rules      	| SystemReboot                  	 | Перезагрузка системы                                                                                 	                                                  | Не требует реагирования                          	                                                                                                                                                                                                                                                                                                                |
| liftbridge.rules 	| CorrelatorQueueTooLarge       	 | Алармы сервиса correlator выстраиваются в очередь более чем на 1000 в течение как минимум пяти минут 	                                                  | Посмотреть в графиках как долго длится ситуация, зайти в логи correlator'a, ребутнуть сервис                         	                                                                                                                                                                                                                                            |
| liftbridge.rules 	| ClassifierQueueTooLarge       	 | Алармы сервиса classifier выстраиваются в очередь более чем на 1000 в течение как минимум пяти минут 	                                                  | Посмотреть в графиках как долго длится ситуация, зайти в логи classifier'a, ребутнуть сервис                          	                                                                                                                                                                                                                                           |
| liftbridge.rules 	| UncommitedMessagesTooMuch     	 | Не все сообщения записаны на все реплики согласно числу isr                                                     	                                       | Посмотреть логи всех лифтбриджей, наверное одна из нод кластера отвалилась, либо не выполнены миграции лифтбриджа                           	                                                                                                                                                                                                                     |
| liftbridge.rules 	| StreamInvertedValue           	 | В партиции нет сообщений                                                                 	                                                              | Исравляется пересозданием стрима                          	                                                                                                                                                                                                                                                                                                       |
| mongo.rules      	| MongoClasterServerCountChange 	 | Член кластера Mongodb, вероятно, мертв                                                               	                                                  | Посмотреть логи, перезапустить сервис                         	                                                                                                                                                                                                                                                                                                   |
| mongo.rules      	| MongoConnectionLow            	 | Мало коннектов до MongoDB                                                                   	                                                 	         | Выяснить почему до ноды никто не может подключиться                                                                                                                                                                                                                                                                                                               
| mongo.rules      	| MongoReplicationLag           	 | Задержка репликации на Mongodb                                                                             	                                            | Проверить логи, запустить resync                          	                                                                                                                                                                                                                                                                                                       |
| noc.rules  ?!    	| FMNoEscalations               	 | Число созданных ицидентов во внешней системе равно нулю долгое время, возможно произошла авария                               	                         | Проверить логи эскалатора, статус сервиса, посмотреть графики аварий  	                                                                                                                                                                                                                                                                                           |
| noc.rules        	| FmTooManyAlerts               	 | Высокий процент аварийных сигналов                                                                   	                                                  | Посомтреть на графиках                          	                                                                                                                                                                                                                                                                                                                 |
| noc.rules        	| LateTasksOnPool               	 | Задержка тасок на 10 минут в пуле                                                                    	                                                  | Посмотреть график, посмотреть логи активатора                          	                                                                                                                                                                                                                                                                                          |
| noc.rules        	| LateTasksScheduler            	 | Очередь тасок шедулера перегружена                                                                   	                                                  | Идити в логи шедулера, посмотреть на графики аварий, если аварий нет то связано с долгим временем ответа от базы данных                          	                                                                                                                                                                                                                |
| noc.rules        	| HighTracesPerSecond           	 | Слишком много трейсов от активатора                                                               	                                                     | Идти в логи активатора, скорее всего связано с ошибками в профилях железок                          	                                                                                                                                                                                                                                                             |
| noc.rules         | HighTracesPerSecond             | Слишком много трейсов от не активатора                                                                                                                  | Посмотреть в логах сервиса, возможно связано с недоступностью базы данных                                                                                                                                                                                                                                                                                         |
| postgres.rules   	| PostgresqlDeadlocksHigh       	 | Обнаружены дедлоки на посгресе                                                                       	                                                  | Если идут пачкой, то идём в логи посгреса, ищем дедлок                           	                                                                                                                                                                                                                                                                                |
| postgres.rules   	| PostgresqlBackendsLow         	 | Мониторит сколько свободных клиентов может подключиться                                         	                                                       | Поставить пгбаунсер, увеличить кол-во тредов, посмотреть какие подключения висят на посгресе и не уходят                          	                                                                                                                                                                                                                               |
| prometheus.rules 	| ServiceDown                   	 | Прометеус не может соединиться с экспортером                                                       	                                                    | Зайти на ноду с экспортером, проверить доступность экспортера, посмотреть логи, ребутнуть                          	                                                                                                                                                                                                                                              |
| self.rules       	| DeadMansSwitch                	 | Система для проверки алертов, должна гореть всегда                                                                                                    	 | Проверить работает ли мониторинг конкретно с этого места                          	                                                                                                                                                                                                                                                                               |